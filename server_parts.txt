

 СЕРВЕР АВТОРИЗАЦИИ

Аутентификация

Поддерживает определение игрока с помощью пары логин-пароль или аккаунта в фейсбуке, а также сохраненного ранее ключа и шифра.
Сохраняет в базу данных аккаунт, если пришел новый игрок.
После успешной ручной аутентификации создает новый шифр и ключ, отправляет их игроку.
Автоматическая аутентификация происходит следующим образом: клиент отправляет свой ключ, сервер находит аккаунт по этому ключу, генерирует случайный набор символов, сохраняет в базу данных связанным с ключом игрока и отправляет этот набор клиенту, клиент подписывает полученую фразу своим шифром и отправляет серверу со своим ключом, сервер по ключу получает из базы данных сохраненную фразу, оригинальный шифр аккаунта, подписывает фразу своим шифром и сравнивает с присланной клиентом подписанной фразой, если подписанные фразы совпадают, то авторизация прошла успешно.
Авторизованный игрок отправляется в блок балансировщика.

Балансировщик серверов менеджмента

Выбирает наименее заполненный не пустой сервер менеджмента и отправляет туда игрока.
При этом генерируется уникальный ключ, сохраняемый в базу данных с пометкой номера сервера менеджмента, и отправляемый игроку.


 СЕРВЕР БАЛАНСИРОВКИ

Разделение и миграция серверов менеждмента

С некоторой периодичностью проверяется населенность серверов менеджмента.
Достигшему пика населенности серверу менеджмента отправляются данные пустого сервера, куда необходимо отправить игроков.
Сервер менеджмента должен сам определить свободных игроков, которым необходимо мигрировать на другой сервер.

Балансировщик игровых серверов

С некоторой периодичностью проверяется населенность игровых серверов, и достигшим пика населенности игровым серверам отправляется запрос на разделение с информацией о пустом сервере, куда будет происходить миграция.


 СЕРВЕР МЕНЕДЖМЕНТА

Перемещение по карте

От игрока приходит запрос на перемещение в указанный регион.
Сервер строит маршрут движения и устанавливает таймеры, после чего отправляет данные для отображения игроку.
В середине цикла единичного перехода рассчитывается шанс случайной встречи, и если она происходит, то игрок добавляется в список ожидающих случайной встречи. Достигнув конца единичного цикла перехода игрок, не попавший в пару и не перешедший в бой выбирает из списка ожидающих случайной встречи подходящего соперника и инициирует бой.
Достигнув конца единичного цикла не встретив соперников, игрок переходит к следующему единичному циклу, и так вплоть до конца маршрута.
Достигнув конца маршрута игрок переходит на регион.

Переход на игровой сервер

Сервер генерирует уникальный ключ, сохраняет его в базу данных и отправляет игроку.
В случае перехода на регион в базе данных оставляется пометка о регионе, в который попадет игрок, а также выбирается подходящий игровой сервер с близкими по рангу игроками.
Если игрок переходит в бой при случайной встрече, то выбирается наименее загруженный игровой сервер, а в базе данных оставляется пометка о сопернике.

Результаты боевой сессии

При получении от игрового сервера результатов боя или выхода из региона сервер менеджмента вносит соответствующие изменения в базу данных, такие как: изменение очков ранга игрока, открытие мест, изменение местоположения на глобальной карте, получение травм, зачисление валюты и трофеев, выполнение заданий.

Интерфейс банка

Сервер отправляет игроку список доступных пакетов для покупки и информацию о скидках.
Сохраняет выбранный игроком для покупки пакет и после подтверждения оплаты зачисляет игроку валюту.
При завершении покупки изменяет ставки скидок на пакеты.

Интерфейс профиля

Сохраняет новый пароль для аккаунта, если регистрация происходила через пару логин-пароль.
Изменяет игровой ник игрока, первый раз бесплатно, второй раз за валюту.

Интерфейс магазина

Сервер отправляет игроку список доступных товаров с ценами.
Осуществляет покупку, с зачислением купленных благ и списанием игровой валюты.

Интерфейс кузницы

Сервер отправляет игроку список доступных чертежей сюрикенов и их частей.
Сохраняет в базу данных информацию о созданном сюрикене и потраченных расходных материалах.
Производит заточку сюрикена, рассчитывая шанс заточки и сохраняя результат в базу данных, со списанием расходного материала.
Сохраняет в базу данных новый скин сюрикена.
Сохраняет в базу данных новую смазку сюрикена и списывает расходник.

Интерфейс чайной

Сервер отправляет игроку список друзей с их статусами и местоположением.
Отправляет другу игрока запрос на поединок и впоследствии инициирует поединок.
Открывает профиль друга для просмотра.

Интерфейс профиля друга

Сервер отправляет все доступные данные о друге клиенту для отображения.

Интерфейс колеса фортуны

Рассчитывает приз на основе списка вероятностей, сохраняет изменения в базу данных и отправляет игроку для отображения.

Интерфейс алтаря

Отправляет игроку все доступные статистические данные о нем самом для отображения.

Интерфейс журнала

Отправляет игроку списки произошедших с ним событий постранично по запросу.

Интерфейс заданий

Отправляет игроку список текущих и выполненных недавно заданий с их статусами и описанием.

Интерфейс инвентаря

Отправляет игроку доступные костюмы, сюрикены, способности.
Сохраняет в базу данных выбранный костюм, сюрикен или способности.


 ИГРОВОЙ СЕРВЕР (РЕГИОН И БОЙ)

Авторизация

От клиента приходит ключ, сервер находит по ключу запись в базе данных, берет характеристики персонажа из профиля найденного игрока.
Если игрок пришел на регион, то добавляет его к региону.
Если игрок пришел в поединок, то ожидает соперника, после чего инициирует поединок.

Регион

При инициализации определяется точка входа, на клиент отправляется информация: локация, координаты.
При движении высчитываются встречи с другими игроками и разрыв связей с далёкими соперниками.
Обрабатывается бросок кошки.
Пересылаются смайлы видимым соперникам.
При столкновении двух игроков инициируется поединок.

Поиск противника на регионе

Встреча с другими игроками вычисляется с некоторой периодичностью.
Если встреча необходима, то подбирается короткий список наиболее релевантных кандидатов и из него выбирается случайным образом соперник.
Релевантность определяется по следующим критериям: разница в ранге игроков (если игрок побеждал на регионе, то соперники подмешиваются сильнее по рангу из не побеждавших), по направлению движения (встречное движение).

Формирование поединка

На локации другие игроки уведомляются о поединке, для них пара игроков пропадает, остается только иконка поединка.
Соперникам отправляется уведомление о инициализации поединка с необходимыми данными: локация, выбранные сюрикен, способности, костюм соперника.
После этого запускает бой.

Поединок

Эмуляция движения персонажа, полёта сюрикена, действия способностей, изменения характеристик персонажей с рассчитанными заранее событиями.
Синхронизация с клиентом.
Обработка броска.
Обработка использования способности.
Подготовка результатов боя и запись их в базу данных.

 БАЗА ДАННЫХ REDIS (КЕШИРУЮЩАЯ)

Кеш аккаунтов игроков (короткий, обновляется при изменении на эталоне)
Ключи поединков
Ключи входа на регион
...


 БАЗА ДАННЫХ POSTGRESQL (ЭТАЛОННАЯ И ЛОГИРУЮЩАЯ)

Аккаунты игроков с логином-паролем или идентификатором фейсбук, персональным ключом, шифром, ником, датой последнего входа, переменными
Инвентарь игроков
Таймеры игроков
...



